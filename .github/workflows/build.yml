name: Build Windows MSI Installer

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      version:
        description: 'ç‰ˆæœ¬å·ï¼ˆä¾‹å¦‚ï¼š1.0.0ï¼‰'
        required: false
        type: string

permissions:
  contents: write  # å…è®¸åˆ›å»º Release å’Œä¸Šä¼ æ–‡ä»¶

jobs:
  build:
    strategy:
      matrix:
        os: [windows-latest]
        include:
          - os: windows-latest
            target: Msi
            artifact_name: "*.msi"
            artifact_path: "build/compose/binaries/main/msi/"
    
    runs-on: ${{ matrix.os }}
    timeout-minutes: 30
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # éœ€è¦å®Œæ•´åŽ†å²æ¥èŽ·å–æ ‡ç­¾ä¿¡æ¯
    
    - name: Extract version from tag
      id: version
      shell: bash
      run: |
        if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
          # ä»Žæ ‡ç­¾ä¸­æå–ç‰ˆæœ¬å·ï¼ˆåŽ»æŽ‰ v å‰ç¼€ï¼‰
          VERSION="${{ github.ref_name }}"
          VERSION="${VERSION#v}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "package_version=$VERSION" >> $GITHUB_OUTPUT
        elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
          # æ‰‹åŠ¨è§¦å‘æ—¶ï¼Œå°è¯•ä»Žè¾“å…¥èŽ·å–ç‰ˆæœ¬å·ï¼Œå¦‚æžœæ²¡æœ‰åˆ™ä½¿ç”¨é»˜è®¤å€¼
          VERSION="${{ github.event.inputs.version }}"
          if [ -z "$VERSION" ]; then
            VERSION="1.0.0"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "package_version=$VERSION" >> $GITHUB_OUTPUT
        else
          # å…¶ä»–æƒ…å†µä½¿ç”¨é»˜è®¤ç‰ˆæœ¬å·
          VERSION="1.0-SNAPSHOT"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "package_version=1.0.0" >> $GITHUB_OUTPUT
        fi
        echo "ðŸ“¦ æž„å»ºç‰ˆæœ¬: $VERSION"
        echo "ðŸ“¦ åŒ…ç‰ˆæœ¬: $(cat $GITHUB_OUTPUT | grep package_version | cut -d= -f2)"
    
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Configure Gradle for CI
      shell: bash
      run: |
        mkdir -p ~/.gradle
        echo "org.gradle.daemon=false" >> ~/.gradle/gradle.properties
        echo "org.gradle.parallel=false" >> ~/.gradle/gradle.properties
        echo "org.gradle.caching=false" >> ~/.gradle/gradle.properties
        echo "org.gradle.configureondemand=false" >> ~/.gradle/gradle.properties
        cat ~/.gradle/gradle.properties
    
    - name: Verify WiX Toolset
      shell: pwsh
      run: |
        $wixPath = "C:\Program Files (x86)\WiX Toolset v3.11\bin"
        if (Test-Path $wixPath) {
          Write-Host "âœ“ WiX Toolset found at $wixPath"
          echo "$wixPath" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
        } else {
          Write-Host "âš  WiX Toolset not found, but jpackage should work"
        }
    
    - name: Package ${{ matrix.target }}
      shell: cmd
      run: gradlew.bat package${{ matrix.target }} --no-daemon --console=plain --info
      timeout-minutes: 25
      env:
        GRADLE_OPTS: "-Dorg.gradle.daemon=false -Dorg.gradle.parallel=false -Dfile.encoding=UTF-8"
        BUILD_VERSION: ${{ steps.version.outputs.version }}
        PACKAGE_VERSION: ${{ steps.version.outputs.package_version }}
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: workhub-${{ runner.os }}
        path: ${{ matrix.artifact_path }}${{ matrix.artifact_name }}
        retention-days: 7
    
    - name: Upload to Release
      if: startsWith(github.ref, 'refs/tags/v')
      continue-on-error: true
      uses: softprops/action-gh-release@v1
      with:
        files: ${{ matrix.artifact_path }}${{ matrix.artifact_name }}
        fail_on_unmatched_files: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

